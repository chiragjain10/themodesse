<template>
    <div class="header-middle sticky-header fix-top sticky-content">
        <div class="container">
            <div class="header-section">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="#" class="mobile-menu-toggle">
                        <i class="d-icon-bars2"></i>
                    </a>
                    <a href="/" class="logo d-md-block me-0">
                        <img src="/src/assets/images/Phalit-Logo-name.png" alt="logo" width="100%" />
                    </a>
                </div>
                <a href="/" class="logo d-md-block d-none">
                    <img src="/src/assets/images/Phalit-Logo-name.png" alt="logo" width="100%" />
                </a>
                <nav class="main-nav">
                    <ul class="menu">
                        <li>
                            <a href="shop.html">Gemstone</a>
                            <div class="megamenu">
                                <div class="container">
                                    <div class="row">
                                        <div class="col-6 col-sm-4 col-md-4 col-lg-3">
                                            <h4 class="menu-title">RASHI RATNA</h4>
                                            <ul>
                                                <li><a href="#">Yellow Sapphire/Pukhraj</a></li>
                                                <li><a href="#">Blue Sapphire/Neelam</a></li>
                                                <li><a href="#">Ruby/Manik</a></li>
                                                <li><a href="#">Emerald/Panna</a></li>
                                                <li><a href="#">Red Coral/Moonga</a></li>
                                                <li><a href="#">Hessonite/Gomed</a></li>
                                                <li><a href="#">Pearl</a></li>
                                                <li><a href="#">Cat's Eye/Lehsuniya</a></li>
                                                <li><a href="#">Opal</a></li>
                                            </ul>
                                        </div>
                                        <div class="col-6 col-sm-4 col-md-4 col-lg-3">
                                            <h4 class="menu-title">VEDIC GEMS</h4>
                                            <ul>
                                                <li><a href="#">Amethyst</a></li>
                                                <li><a href="#">Turquoise/Firoza</a></li>
                                                <li><a href="#">Iolite/Neeli</a></li>
                                                <li><a href="#">Pitambari Neelam</a></li>
                                                <li><a href="#">Citrine/Sunela</a></li>
                                                <li><a href="#">Garnet</a></li>
                                                <li><a href="#">Peridot</a></li>
                                                <li><a href="#">Zircon/Jarkan</a></li>
                                            </ul>
                                        </div>
                                        <div class="col-6 col-sm-4 col-md-4 col-lg-3">
                                            <h4 class="menu-title">OTHER GEMS</h4>
                                            <ul>
                                                <li><a href="#">Tiger's Eye</a></li>
                                                <li><a href="#">Jasper</a></li>
                                                <li><a href="#">Moonstone</a></li>
                                                <li><a href="#">Lapis Lazuli</a></li>
                                                <li><a href="#">Keshi Pearl</a></li>
                                                <li><a href="#">South Sea Pearl</a></li>
                                            </ul>
                                        </div>
                                        <div
                                            class="col-6 col-sm-4 col-md-4 col-lg-3 menu-banner menu-banner1 banner banner-fixed">
                                            <figure>
                                                <img src="/src/assets/images/menu/banner-1.jpg" alt="Menu banner"
                                                    width="221" height="330" />
                                            </figure>
                                            <div class="banner-content y-50">
                                                <h4 class="banner-subtitle font-weight-bold text-primary ls-m">Sale.
                                                </h4>
                                                <h3 class="banner-title font-weight-bold"><span
                                                        class="text-uppercase">Up
                                                        to</span>70% Off</h3>
                                                <a href="shop.html" class="btn btn-link btn-underline">shop now<i
                                                        class="d-icon-arrow-right"></i></a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li>
                            <a href="product.html">Rudraksha</a>
                            <div class="megamenu">
                                <div class="container">
                                    <div class="row">
                                        <div class="col-6 col-sm-4 col-md-3">
                                            <h4 class="menu-title">1-16 Mukhi Rudraksha</h4>
                                            <ul>
                                                <li><a href="#">1 Mukhi Rudraksha Savar (Nepali)</a></li>
                                                <li><a href="#">2 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">3 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">4 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">5 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">6 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">7 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">8 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">9 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">10 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">11 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">12 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">13 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">14 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">15 Mukhi Rudraksha (Nepali)</a></li>
                                                <li><a href="#">16 Mukhi Rudraksha (Nepali)</a></li>
                                            </ul>
                                        </div>
                                        <div class="col-6 col-sm-4 col-md-3">
                                            <h4 class="menu-title">Rudraksha Mala</h4>
                                            <ul>
                                                <li><a href="#">Japa Mala</a></li>
                                                <li><a href="#">Holistic Healing Rudraksha Mala</a></li>
                                                <li><a href="#">Silver Rudraksha Mala</a></li>
                                            </ul>
                                        </div>
                                        <div class="col-6 col-sm-4 col-md-3">
                                            <h4 class="menu-title">Rudraksha Bracelets</h4>
                                            <ul>
                                                <li><a href="#">Rudraksha Kids Bracelet</a></li>
                                            </ul>
                                        </div>
                                        <div
                                            class="col-6 col-sm-4 col-md-3 menu-banner menu-banner2 banner banner-fixed">
                                            <figure>
                                                <img src="/src/assets/images/menu/banner-2.jpg" alt="Menu banner"
                                                    width="221" height="330" />
                                            </figure>
                                            <div class="banner-content x-50 text-center">
                                                <h3 class="banner-title text-white text-uppercase">Gemstone</h3>
                                                <h4 class="banner-subtitle font-weight-bold text-white mb-0">$23.00
                                                    -
                                                    $120.00</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li>
                            <a href="product.html">Bracelet</a>
                            <div class="megamenu">
                                <div class="container">
                                    <div class="row justify-content-center">
                                        <div class="col-6 col-sm-4 col-md-3">
                                            <h4 class="menu-title">Bracelet</h4>
                                            <ul>
                                                <li><a href="#">7 Chakra Bracelet</a></li>
                                                <li><a href="#">7 Chakra Chips Pyramid</a></li>
                                                <li><a href="#">7 chakra Hematite Bracelet</a></li>
                                                <li><a href="#">Aquamarine Pyramids</a></li>
                                                <li><a href="#">Amethyst Bracelet</a></li>
                                                <li><a href="#">Black Obsidian</a></li>
                                                <li><a href="#">Bloodstone Bracelet</a></li>
                                                <li><a href="#">Brown Tiger Eye Bracelet</a></li>
                                                <li><a href="#">Guidance Set</a></li>
                                                <li><a href="#">Moonstone Bracelet</a></li>
                                                <li><a href="#">All Crystal Bracelets</a></li>
                                            </ul>
                                        </div>
                                        <div
                                            class="col-6 col-sm-4 col-md-3 menu-banner menu-banner2 banner banner-fixed">
                                            <figure>
                                                <img src="/src/assets/images/menu/banner-2.jpg" alt="Menu banner"
                                                    width="221" height="330" />
                                            </figure>
                                            <div class="banner-content x-50 text-center">
                                                <h3 class="banner-title text-white text-uppercase">Premium Gemstone</h3>
                                                <h5 class="banner-subtitle font-weight-bold text-white mb-0">Designed to
                                                    inspire, empower, and energize your day.</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li>
                            <a href="#">Our Story</a>
                        </li>
                        <li>
                            <a href="#">Track Your Order</a>
                        </li>
                    </ul>
                </nav>
                <div class="d-flex justify-content-end align-items-center">
                    <span class="divider"></span>
                    <div v-if="wishlist.loading" class="text-center py-4">Loading...</div>
                    <div v-else class="dropdown wishlist wishlist-dropdown off-canvas">
                        <a href="#" class="wishlist-toggle">
                            <i class="d-icon-heart"></i>
                            <span v-if="wishlist.items.length" class="wishlist-count">{{ wishlist.items.length }}</span>
                        </a>
                        <div class="canvas-overlay"></div>
                        <div class="dropdown-box scrollable">
                            <div class="canvas-header">
                                <h4 class="canvas-title">wishlist</h4>
                                <a href="#" class="btn btn-dark btn-link btn-icon-right btn-close">close<i
                                        class="d-icon-arrow-right"></i><span class="sr-only">wishlist</span></a>
                            </div>
                            <div v-if="wishlist.loading" class="text-center py-4">Loading...</div>
                            <div v-else class="products scrollable">
                                <div v-if="wishlist.items.length === 0" class="text-center py-4">No items in wishlist.
                                </div>
                                <div v-for="item in wishlist.items" :key="item.id" class="product product-wishlist">
                                    <figure class="product-media">
                                        <RouterLink :to="`/product/${item.product.slug}`">
                                            <img :src="item.product.image" width="100" height="100"
                                                :alt="item.product.name" />
                                        </RouterLink>
                                        <button class="btn btn-link btn-close"
                                            @click="wishlist.removeFromWishlist(item.product_id)">
                                            <i class="fas fa-times"></i><span class="sr-only">Close</span>
                                        </button>
                                    </figure>
                                    <div class="product-detail">
                                        <RouterLink :to="`/product/${item.product.slug}`" class="product-name">{{
                                            item.product.name }}</RouterLink>
                                        <div class="price-box">
                                            <span class="product-price">${{ item.product.sale_price }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <a href="/wishlist" class="btn btn-dark wishlist-btn mt-4"><span>Go To Wishlist</span></a>
                        </div>
                    </div>
                    <span class="divider"></span>
                    <!-- Cart -->
                    <div class="dropdown cart-dropdown type2 off-canvas mr-0 mr-lg-2">
                        <a href="#" class="cart-toggle label-block link" @click.prevent="handleCartClick">
                            <i class="d-icon-bag"><span class="cart-count">{{ cartCount }}</span></i>
                        </a>
                        <div class="canvas-overlay"></div>
                        <div class="dropdown-box" v-if="auth.isAuthenticated">
                            <div class="canvas-header">
                                <h4 class="canvas-title">Shopping Cart</h4>
                                <a href="#" class="btn btn-dark btn-link btn-icon-right btn-close">close<i
                                        class="d-icon-arrow-right"></i></a>
                            </div>
                            <div class="products scrollable">
                                <template v-if="loading">
                                    <div class="col-xs-6 col-lg-3 mb-4" v-for="n in 4" :key="n">
                                        <div class="category shimmer-loader">
                                            <div class="skeleton-img"></div>
                                            <div class="skeleton-text mt-2"></div>
                                        </div>
                                    </div>
                                </template>
                                <template v-else>
                                    <template v-if="cartItems && cartItems.length > 0">
                                        <div v-for="item in cartItems" :key="item.id" class="product product-cart">
                                            <figure class="product-media">
                                                <a :href="'/product/' + item.product?.slug">
                                                    <img :src="item.product?.image" :alt="item.product?.name" width="80"
                                                        height="88" />
                                                </a>
                                                <button class="btn btn-link btn-close"
                                                    @click="removeFromCart(item.item_id)">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </figure>
                                            <div class="product-detail">
                                                <a :href="'/product/' + item.product?.slug" class="product-name">{{
                                                    item.product?.name }}</a>
                                                <div class="price-box">
                                                    <div class="quantity-wrapper">
                                                        <!-- <button class="quantity-btn"
                                                            @click="updateQuantity(item.item_id, Number(item.qty) - 1)"
                                                            :disabled="Number(item.qty) <= 1">-</button> -->
                                                        <span class="product-quantity">{{ item.qty }}</span>
                                                        <!-- <button class="quantity-btn"
                                                            @click="updateQuantity(item.item_id, Number(item.qty) + 1)">+</button> -->
                                                    </div>
                                                    <span class="product-price">₹{{ (Number(item.product?.sale_price) *
                                                        Number(item.qty)).toFixed(2) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    <template v-else>
                                        <div class="empty-cart mt-4">
                                            <p>Your cart is empty.</p>
                                        </div>
                                    </template>
                                </template>
                            </div>
                            <div class="cart-total">
                                <label>Subtotal:</label>
                                <span class="price">₹{{ cartTotal }}</span>
                            </div>
                            <div class="cart-action">
                                <router-link to="/cart" class="btn btn-dark btn-link">View Cart</router-link>
                                <router-link to="/checkout" class="btn btn-dark"><span>Go To
                                        Checkout</span></router-link>
                            </div>
                        </div>
                    </div>
                    <span class="divider ms-2"></span>
                    <div class="dropdown cart-dropdown type2 off-canvas mr-0 mr-lg-2">
                        <a href="#" class="cart-toggle label-block link">
                            <i class="d-icon-user"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, onMounted, computed, watch } from 'vue'
import { useCartStore } from '@/stores/cart'
import { useAuthStore } from '@/stores/auth'
import { RouterLink } from 'vue-router'
import { useWishlistStore } from '@/stores/wishlist'

const wishlist = useWishlistStore()
onMounted(() => wishlist.fetchWishlist())

const cart = useCartStore()
const auth = useAuthStore()

// Computed property for cart total and items
const cartTotal = computed(() => cart.total)
const cartItems = computed(() => cart.items)
const cartCount = computed(() => cart.count)
const loading = computed(() => cart.loading)

// Function to fetch cart data
const fetchCartData = async () => {
    if (!auth.isAuthenticated || !auth.user?.id) {
        console.warn('fetchCartData: User not authenticated or ID missing');
        return;
    }
    try {
        await cart.fetchCart();
    } catch (error) {
        console.error('Error fetching cart:', error);
    }
};

onMounted(async () => {
    if (auth.token) {
        try {
            await auth.fetchUser()
            if (auth.user?.id) {
                await fetchCartData()
            }
        } catch (error) {
            console.error('Error fetching user data:', error)
        }
    }
})

// Watch for auth changes
watch(() => auth.isAuthenticated, async (newValue) => {
    if (newValue && auth.user?.id) {
        await fetchCartData()
    }
})

// Also watch for user data changes
watch(() => auth.user, async (newUser) => {
    if (newUser?.id) {
        await fetchCartData()
    }
}, { immediate: true })

const removeFromCart = async (itemId) => {
    if (!auth.isAuthenticated || !auth.user?.id) return
    try {
        await cart.removeItem(itemId)
        await fetchCartData()
    } catch (error) {
        console.error('Error removing item from cart:', error)
    }
}

const updateQuantity = async (itemId, newQuantity) => {
    if (!auth.isAuthenticated || !auth.user?.id) return
    const item = cart.items.find(i => i.id === itemId)
    if (!item || newQuantity < 1) return
    try {
        await cart.updateItem(itemId, item.product.id, Number(newQuantity))
        await fetchCartData()
    } catch (error) {
        console.error('Error updating cart item:', error)
    }
}

const handleCartClick = () => {
    if (!auth.isAuthenticated) {
        window.location.href = '/login'
    }
}
</script>

<style scoped>
.logo img {
    width: 100%;
}

@media (max-width: 768px) {
    .logo img {
        width: 100%;
    }

    .header-middle {
        padding: 0;
    }
}

.header-middle {
    padding-top: 10px;
    padding-bottom: 10px;
}

.header .container {
    display: initial
}

.header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.menu>li .megamenu,
.menu>li>ul {
    left: -100%;
    right: 0;
    width: 100vw;
}

.header-middle[data-v-760b4c2d] {
    padding: 0;
}

.menu>li.show .megamenu,
.menu>li.show>ul,
.menu>li:hover .megamenu,
.menu>li:hover>ul {
    top: 105%;
}

.submenu {
    padding: 3px 0;
}
</style>